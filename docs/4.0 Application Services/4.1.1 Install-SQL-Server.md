# Install SQL Server

## Overview
This document provides a step-by-step guide for installing and configuring SQL Server. It covers prerequisites, server preparation, installation, and post-installation configuration to ensure a robust and optimized SQL Server setup.

## Prerequisites
- Verify that all required disks are mounted and online:
  - `D:\` (Data), `E:\` (Program), `F:\` (Backup), `L:\` (Log), and `T:\` (TempDB).
- Ensure permissions in Active Directory for creating the service accounts.
- Internet access for downloading required modules.
- PowerShell installed on the server.
- SQL Server installation media available.

---

## Prepare PowerShell

Before we begin the installation of SQL Server, we need to configure PowerShell and install a couple of modules.

### Execution Policy

Set execution policy to bypass so we can run PowerShell commands. If you restart PowerShell during this guide, you will need to run the below script again each time PowerShell is restarted.

```powershell
Set-ExecutionPolicy -ExecutionPolicy Bypass -Scope CurrentUser -Force
```

#### Parameters:
- **`-ExecutionPolicy`**: Specifies the new execution policy. `Bypass` allows scripts to run without restrictions.
- **`-Scope`**: Defines the scope of the policy. `CurrentUser` applies the policy to the current user only.
- **`-Force`**: Suppresses confirmation prompts.

### Install DBAtools Module

The DBAtools module will be used for installing SQL Server and configuring the Availability Group. If a pop-up window appears with the text **NuGet provider is required to continue**, select **Yes**.

The client or server needs to have internet access for this to work.

```powershell
If (!(Get-Module DBATools -ListAvailable)) {Install-Module DBATools -Scope CurrentUser -Force}
```

#### Parameters:
- **`-ListAvailable`**: Checks if the module is already installed.
- **`-Scope`**: Installs the module for the current user.
- **`-Force`**: Forces the installation without confirmation.

## Prepare server

Before we begin the installation of SQL Server we will verify that the server is configured correctly.

### Prepare Disks

If disks are attached to the VM but not initialized and formatted, you can run the following script. Note that you need to change the `-PartitionNumber` depending on which partition number the larger partition is.

This should show you all available disks. 

```powershell
Get-Disk
```

#### Parameters:
- **`Get-Disk`**: Lists all available disks on the system.

In our example, the Data disk (`D:\`) is number 1.

```powershell
$number = 1
get-disk -Number $number | Clear-Disk -RemoveData -Confirm:$false
Initialize-Disk -Number $number
New-Partition -DiskNumber $number -UseMaximumSize | Format-Volume -FileSystem NTFS -NewFileSystemLabel "SQL Data" -AllocationUnitSize 65536 -Confirm:$false
Get-Partition -DiskNumber $number -PartitionNumber 2 | Set-Partition -NewDriveLetter D
```

#### Parameters:
- **`-Number`**: Specifies the disk number to operate on.
- **`Clear-Disk`**: Removes all data from the specified disk.
- **`Initialize-Disk`**: Initializes the disk for use.
- **`New-Partition`**: Creates a new partition on the disk.
- **`Format-Volume`**: Formats the partition with the specified file system and label.
- **`Set-Partition`**: Assigns a drive letter to the partition.

If you are unsure which PartitionNumber you should use, see all available options. You will need to choose the largest of the partitions.

```powershell
Get-Partition -DiskNumber $number
```

If you are initializing the disks that is not used for SQL Data, Log or TempDb you can run

```powershell
$number = 5
get-disk -Number $number | Clear-Disk -RemoveData -Confirm:$false
Initialize-Disk -Number $number
New-Partition -DiskNumber $number -UseMaximumSize | Format-Volume -FileSystem NTFS -NewFileSystemLabel "Backup" -Confirm:$false
Get-Partition -DiskNumber $number -PartitionNumber 2 | Set-Partition -NewDriveLetter Z

```

### Disk Allocation Unit Size

A good practice for disk allocation unit size for the data, log, and TempDB disks is 64 KB (65536 bytes).

```powershell
Get-Volume | Select-Object FileSystemLabel,DriveLetter,DriveType,AllocationUnitSize | Format-Table -AutoSize
```

#### Parameters:
- **`Get-Volume`**: Retrieves information about the volumes on the system.
- **`Select-Object`**: Filters and selects specific properties to display.
- **`Format-Table`**: Formats the output as a table for better readability.

Below script will reformat data, log, and TempDB disks to the correct size. Note that this script expects that `D:` is Data, `L:` is Log, and `T:` is TempDB.

```powershell
Get-Volume -DriveLetter D | Format-Volume -AllocationUnitSize 65536 -NewFileSystemLabel "SQL Data" -Confirm:$false
Get-Volume -DriveLetter L | Format-Volume -AllocationUnitSize 65536 -NewFileSystemLabel "SQL Log" -Confirm:$false
Get-Volume -DriveLetter T | Format-Volume -AllocationUnitSize 65536 -NewFileSystemLabel "SQLTempDB" -Confirm:$false
```

#### Parameters:
- **`-DriveLetter`**: Specifies the drive letter of the volume to format.
- **`Format-Volume`**: Formats the volume with the specified allocation unit size and label.
- **`-AllocationUnitSize`**: Sets the allocation unit size for the volume.
- **`-NewFileSystemLabel`**: Assigns a new label to the volume.
- **`-Confirm`**: Suppresses confirmation prompts.

### Power Settings

The power plan on the VM should always be set to High Performance. This setting also needs to be verified in BIOS and on the Hypervisor if we are running on a VM.

```powershell
Set-DbaPowerPlan -PowerPlan 'High Performance' -ComputerName $(hostname)
```

#### Parameters:
- **`-PowerPlan`**: Specifies the power plan to set. `High Performance` ensures optimal performance.
- **`-ComputerName`**: Specifies the target computer for the power plan setting.

### Set Firewall Rules

```powershell
New-DbaFirewallRule -SqlInstance localhost
```

#### Parameters:
- **`-SqlInstance`**: Specifies the SQL Server instance for which the firewall rule is created. `localhost` targets the local instance.

### Create Group Managed Service Accounts (gMSA)

Prior to being able to create a gMSA in the domain, the Key Distribution Service needs to have a root key in place to function. Issue the following PowerShell command:

```powershell
Test-KdsRootKey -KeyId (Get-KdsRootKey).KeyId
```

If there is not a valid KDS Root Key then use the following to create one:

```powershell
Add-KdsRootKey -EffectiveImmediately 
```

Be aware that even with the EffectiveImmediately configuration switch it can take up to ten hours for the key to become active and allow the creation of the group Managed Service Accounts.

#### Creating Active Directory Group

This script creates an Active Directory (AD) security group intended to hold the gMSA members.

```powershell
$groupName = 'db-ag1'
New-ADGroup -Name $groupName -Description "Security group for gMSA accounts used for db-ag1" -GroupCategory Security -GroupScope Global
Add-ADGroupMember -Identity $groupName -Members 'db1$', 'db2$'
```

```powershell
$serviceAccountName = 'db-ag1-gmsa'
New-ADServiceAccount -Name $serviceAccountName -PrincipalsAllowedToRetrieveManagedPassword $groupName -Enabled:$true -DNSHostName db-ag1.company.pri -SamAccountName $serviceAccountName -ManagedPasswordIntervalInDays 30
```
### Install and Validate the gMSA Account

On each SQL Server, ensure the RSAT Active Directory PowerShell feature is installed. A server reboot may be required.

```powershell
Add-WindowsFeature RSAT-AD-PowerShell
```

Install the newly created group Managed Service Account (gMSA):

```powershell
Install-ADServiceAccount -Identity 'db-ag1-gmsa'
```

Verify the gMSA installation and functionality:

```powershell
Test-ADServiceAccount -Identity 'db-ag1-gmsa'
```

## Install SQL Server

Variables that needs to be changed

  * $Path: Path to installation media
  * $Version: Version of SQL Server we want to install. Default is 2019
  * $DeveloperEdition: Can be either $true for installing Developer Edition or $false for installing the edition that the media comes with.

Three pop-up windows will be shown, one for each service account and one for the SA account. Enter the credentials. The domain name needs to be specified for the engine and agent account, example test.net.ad\svc-sql_a-ag01

A pop-up window will be displayed, click Yes and SQL Server will be installed.

```powershell
$Path = "C:\tmp\SQL_2022"
$Version = "2022"
[bool]$DeveloperEdition = $true

$svcAcc = [PSCredential]::new("company.pri\db-ag1-gmsa$", [SecureString]::new())
$saCredential = Get-Credential -Message "Credentials for SA account" 

If ($DeveloperEdition) {Install-DbaInstance -Version $Version -Feature Default -Path $Path -InstancePath E:\Program -DataPath D:\Data -LogPath L:\Logs -TempPath T:\TempDB -BackupPath F:\Backups -EngineCredential $svcAcc -AgentCredential $svcAcc -SaCredential $saCredential -PerformVolumeMaintenanceTasks -AuthenticationMode Mixed -ProductID 22222-00000-00000-00000-00000 -Verbose}
else {Install-DbaInstance -Version $Version -Feature Default -Path $Path -InstancePath E:\Program -DataPath D:\Data -LogPath L:\Logs -TempPath T:\TempDB -BackupPath F:\Backups -EngineCredential $svcAcc -AgentCredential $svcAcc -SaCredential $saCredential -PerformVolumeMaintenanceTasks -AuthenticationMode Mixed -Verbose}
```

## Configure SQL Server

### TempDB

A good practice for TempDB file count is one file for each core up to 8 cores. The file size is by getting the total size of the TempDB volume and fill up 80% of the volume.

Restarting the SQL Server service is required.

```powershell
$tempDBFileCount = (Test-DbaTempDbConfig -SqlInstance $(hostname) | Where-Object {$_.Rule -eq "File Count"}).Recommended
$tempDBFileSize= [math]::round(((Get-Volume -DriveLetter T).Size/1MB) * 0.80)
Set-DbaTempDbConfig -SqlInstance $(hostname) -DataFileCount $tempDBFileCount -DataFileSize $tempDBFileSize

Restart-Service MSSQLSERVER -Force
```


### Max Degree of parallelism

SQL Server 2019 (15.x) introduces automatic recommendations for setting the MAXDOP server configuration option during the installation process based on the number of processors available.

Rule of thumb: set this to the number of physical cores in a single NUMA node (processor) socket on your hardware or less. This number should always be even. Only use the value of 1 if you have specific vendor requirements to disable parallelism, like with Microsoft SharePoint Server.

Variables that needs to be changed

  * $maxdopValue: Set this to the recommended value for the specific server

```powershell
[int]$maxdopValue = 4
Set-DbaSpConfigure -Name MaxDegreeOfParallelism -Value $maxdopValue -SqlInstance $(hostname)
```

### Cost Threshold for Parallelism

The optimizer uses that cost threshold to figure out when it should start evaluating plans 
that can use multiple threads. A good starting point is to set this to between 50 and 75.

```powershell
Set-DbaSpConfigure -Name CostThresholdForParallelism -Value 50 -SqlInstance $(hostname)
```

### Max Memory

This can be tweaked and is more of a suggestion but default setting is not recommended.

If you’re using SQL Server Integration Services, Analysis Services, Reporting Services, 
or any other applications on this server, you may need to lower max memory even 
farther. 

```powershell
Set-DbaMaxMemory -SqlInstance $(hostname)
```

### Enable Agent XPs

```powershell
Set-DbaSpConfigure -Name AgentXPsEnabled -Value 1 -SqlInstance $(hostname)
```

### Enable Default Backup Compression

If we enable Backup Compression as default the backup files will be smaller in size, but the CPU cost will be marginally larger during the time of the backup job.

```powershell
Set-DbaSpConfigure -Name 'DefaultBackupCompression' -Value 1 -SqlInstance $(hostname)
```

### Enable Remote Dedicated Admin Connection

```powershell
Set-DbaSpConfigure -Name 'RemoteDacConnectionsEnabled' -Value 1 -SqlInstance $(hostname)
```

### Enable Database Mail

This is used when sending mail from SQL Server.

```powershell
Set-DbaSpConfigure -Name DatabaseMailEnabled -Value 1 -SqlInstance $(hostname)
```

### Configure Model Database

The Model database should be configured to 256MB for data files and 128MB for log files. This is a soft recommendation and can change depending on system, but this is better than the default.

```powershell
$sql = @" 
USE [master]
GO
ALTER DATABASE [model] MODIFY FILE ( NAME = N'modeldev', SIZE = 512000KB , FILEGROWTH = 262144KB )
GO
ALTER DATABASE [model] MODIFY FILE ( NAME = N'modellog', SIZE = 256000KB , FILEGROWTH = 131072KB )
GO
"@
Invoke-DbaQuery -Database model -Query $sql -SqlInstance $(hostname)
```

### SQLTools database

This database will contain our tools and scripts, including Ola Hallengrens Maintenance Solutions.

```powershell
New-DbaDatabase  -Name SQLTools -SqlInstance $(hostname)
```

#### Installs or updates the First Responder Kit stored procedures.
[Link](https://github.com/BrentOzarULTD/SQL-Server-First-Responder-Kit/tree/master)

```Powershell
Install-DbaFirstResponderKit -Force -Database SQLTools -SqlInstance $(hostname) -Verbose
```

#### Automatically installs or updates sp_WhoisActive by Adam Machanic.
```Powershell
Install-DbaWhoIsActive -Database SQLTools -SqlInstance $(hostname)
```

## SQL Server Agent

### Increase Job History Max Rows and Max Rows per Job

```powershell
$sql = @"
USE [msdb]
GO
EXEC msdb.dbo.sp_set_sqlagent_properties @jobhistory_max_rows=5000,
		@jobhistory_max_rows_per_job=200
GO
"@
Invoke-DbaQuery -Database msdb -Query $sql -SqlInstance $(hostname)
```

### New Dba Operator

```powershell
$sql = @"
USE [msdb]
GO
EXEC msdb.dbo.sp_add_operator @name=N'Dba',
		@enabled=1,
		@pager_days=0,
		@email_address=N'mail@domain.com'
GO
"@

Invoke-DbaQuery -Database msdb -Query $sql -SqlInstance $(hostname)
```

### SQL Server Agent Jobs

Links: https://blog.netnerds.net/2023/05/install-dbamaintenancesolution-now-supports-auto-scheduling/

```powershell
$params = @{
    SqlInstance = "localhost"
    ReplaceExisting = $true
    InstallJobs = $true
    CleanupTime = 720
    AutoScheduleJobs = "DailyFull", "HourlyLog"
    StartTime = "231500"
}

Install-DbaMaintenanceSolution @params -Verbose
```

### Additional resources:

* [Install-DbaInstance](https://docs.dbatools.io/#Install-DbaInstance)
* [Step-by-Step: How to work with Group Managed Service Accounts (gMSA)](https://techcommunity.microsoft.com/blog/itopstalkblog/step-by-step-how-to-work-with-group-managed-service-accounts-gmsa/329864)
* [Using Group Managed Service Accounts with SQL Server](https://www.mssqltips.com/sqlservertip/5340/using-group-managed-service-accounts-with-sql-server/)
* [Configure Managed Service Accounts for SQL Server Always On Availability Groups](https://www.sqlshack.com/configure-managed-service-accounts-for-sql-server-always-on-availability-groups/)