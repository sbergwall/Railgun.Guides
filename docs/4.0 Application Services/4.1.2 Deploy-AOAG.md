# Configure Availability Group

This guide provides steps how to install and configure a SQL Server Availability Group right after the guide for creating of a new SQL Server are done.

## Before you begin

  * Permissions in Active Directory is needed for manage the cluster node object or permission to create the object if the object is not created beforehand.
  * Permission in DNS to create the A record if this is not done beforehand.
  * Permission to create a file share witness if this is not done beforehand.
  * Permssion on the Virtual Computer Objects (vco) and the Cluster Name Object (cno)


## Prepare Powershell

Before we begin the installation of SQL Server we need to configure Powershell and installing a couple of modules.

### Execution Policy

Set execution policy to bypass so we can run Powershell commands. If your restart Powershell during this guide you will need to run the below script again for each time Powershell is restarted.

```powershell
Set-ExecutionPolicy -ExecutionPolicy Bypass -Scope CurrentUser -Force
```

### Install DBAtools module

The DBAtools module will be used for installing SQL Server and configure the Availability Group. If a pop-up windows comes up with the text **NuGet provider is required to continue** select **Yes**.

The client or server needs to have internet access for this to work.

```powershell
If (!(Get-Module DBATools -ListAvailable)) {Install-Module DBATools -Scope CurrentUser -Force}
```

## Install Active Directory module

We will use the Active Directory module to create and configure the service account. If the installation is successfull you will se **Success** under **Exit Code**.

```powershell
Add-WindowsFeature RSAT-AD-PowerShell
```

## Create Failover Cluster

### Cluster Features

This needs to be ran on both servers. A restart is required after installation is completed.

```powershell
Install-WindowsFeature -Name failover-clustering -IncludeManagementTools -Verbose
Install-WindowsFeature -Name NET-Framework-Core -IncludeManagementTools -verbose
```

The rest of the Create Failover Cluster scripts only needs to be ran from one server.

### DNS

If DNS is not prepared we can create the A record by hand. This needs to be done on a client with the DNS tools installed.

Variables that needs to be changed

  * $clustername: Name of Windows Failover Cluster
  * $clusterIPAddress: IP address of Windows Failover Cluster
  * $agName: Name of the Availability Group
  * $agIPAddress: IP of the Availability Group
  * $zoneName: Name of the DNS zone

```powershell
$clustername = 'db-clu1'
$clusterIPAddress = '192.168.1.60'

$agName = 'db-ag1'
$agIPAddress = '192.168.1.61'

$zoneName = "company.pri" 

Add-DnsServerResourceRecordA -Name $clustername -IPv4Address $clusterIPAddress -ZoneName $zoneName -ComputerName dc1
Add-DnsServerResourceRecordA -Name $agName -IPv4Address $agIPAddress -ZoneName $zoneName -ComputerName dc1
```

### File Share Witness

If a file share witness is not created before hand we can do that like this. The scripts need to be run from the file share server.

Variables that needs to be changed

  * $shareName: File share name
  * $Path: The local path to the new directory

```powershell
$shareName = "db-clu1"
$path = "C:\db-clu1\witness"

New-Item -Path $Path -Type Directory
New-SMBShare –Name $shareName –Path $Path –FullAccess Administrators -ReadAccess Users
```

### Create Failover Cluster

Variables that needs to be changed

  * $server1: Name of the first node
  * $server2: Name of the second node
  * $clusterIPAddress: IP address of Windows Failover Cluster
  * $clustername: Name of the cluster
  * $fileshare: UNC path to the smb file share witness


```powershell
$server1 = 'db1'
$server2 = 'db2'
$clusterIPAddress = '192.168.1.60'
$clustername = 'db-clu01'
$fileshare = "\\dc1\db-clu1"

New-Cluster -Name $clustername -Node $server1, $server2 -StaticAddress $clusterIPAddress -NoStorage -Verbose
Set-ClusterQuorum -FileShareWitness $fileshare -Cluster $clustername -Verbose
```

## Availability Group 

### Prerequirements for Availability Group

```powershell
$serviceAccount = 'company\db-ag1-gmsa$'

Enable-DbaAgHadr -SqlInstance $(hostname) -Force | Format-Table 

Get-DbaXESession -SqlInstance $(hostname) -Session AlwaysOn_health | ForEach-Object -Process { $_.AutoStart = $true ; $_.Alter() ; $_ | Start-DbaXESession } | Format-Table

New-DbaEndpoint -SqlInstance $(hostname) -Name hadr_endpoint -Port 5022 -EndpointEncryption Required | Start-DbaEndpoint | Format-Table
New-DbaLogin -SqlInstance $(hostname) -Login $serviceAccount | Format-Table
Invoke-DbaQuery -SqlInstance $(hostname) -Query "GRANT CONNECT ON ENDPOINT::hadr_endpoint TO [$serviceAccount]" 
```

### Create Availability Group


```powershell
$primaryNode = "db1"
$secondaryNode = "db2"
$agName = "db-ag1"
$sharedPath = "\\dc1\db-clu1\tmp"
$tempDbName = "ag_temp"
$IPAddress = '192.168.1.61'

New-DbaDatabase -Name $tempDbName -SqlInstance $primaryNode -RecoveryModel Full
New-DbaAvailabilityGroup -Primary $primaryNode -Secondary $secondaryNode -Name $agName -ClusterType Wsfc -SharedPath $sharedPath -Database $ag_temp -ConfigureXESession -IPAddress $IPAddress -IsContained -AutomatedBackupPreference Secondary 
```


#### Troubleshooting Service Account Login Error

[Dbatools issue 8395](https://github.com/dataplat/dbatools/issues/8395)

If you encounter errors similar to the following when creating the login for the service account:

  Windows NT user or group 'company.pri\db-ag1-gmsa$' not found. Check the name again.

This may indicate that the Windows service is running under a fully qualified domain name (FQDN) instead of the expected domain\sAMAccountName. 

To resolve this issue, run the PowerShell scripts below to update the service account for SQL Server and SQL Server Agent on your nodes:

Update the service account for the SQL Server service and SQL Server Agent:

```powershell  
Update-DbaServiceAccount -Server db1,db2 -ServiceName MSSQLSERVER -Username 'company\db-ag1-gmsa$'
Update-DbaServiceAccount -Server db1,db2 -ServiceName SQLSERVERAGENT -Username 'company\db-ag1-gmsa$'
```

Running these scripts aligns the service account format correctly and should resolve the login creation errors.


### Create Availability Group Listener

Verify that the Virtual Computer Objects (vco) are created as a Computer Object in Active Directory and that the Cluster Name Object (cno) has full access on the object.

```powershell
$IPAddress = "192.168.1.61"
$agListener = "db-ag1"
$SubnetMask = "255.255.255.192"

Get-DbaAvailabilityGroup -SqlInstance $primaryNode -AvailabilityGroup $agName | Add-DbaAgListener -Name $agListener -IPAddress $IPAddress -SubnetMask $SubnetMask -Verbose
```


# ToDO 
* The ad computer object "db-ag1" needs to be created in ad, disabled, and the cluster object "db-clu01" Should have permissions on "db-ag1":

[Create Listener Fails with Message 'The WSFC cluster could not bring the Network Name resource online'](https://techcommunity.microsoft.com/blog/sqlserversupport/create-listener-fails-with-message-the-wsfc-cluster-could-not-bring-the-network-/318235)

* We need to create a db and add it to the failover cluster.