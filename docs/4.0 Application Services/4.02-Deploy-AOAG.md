# Configure Availability Group

This guide provides steps how to install and configure a SQL Server Availability Group right after the guide for creating of a new SQL Server are done.

## Before you begin

  * Permissions in Active Directory is needed for manage the cluster node object or permission to create the object if the object is not created beforehand.
  * Permission in DNS to create the A record if this is not done beforehand.
  * Permission to create a file share witness if this is not done beforehand.
  * Permssion on the Virtual Computer Objects (vco) and the Cluster Name Object (cno)


## Prepare Powershell

Before we begin the installation of SQL Server we need to configure Powershell and installing a couple of modules.

### Execution Policy

Set execution policy to bypass so we can run Powershell commands. If your restart Powershell during this guide you will need to run the below script again for each time Powershell is restarted.

```powershell
Set-ExecutionPolicy -ExecutionPolicy Bypass -Scope CurrentUser -Force
```

### Install DBAtools module

The DBAtools module will be used for installing SQL Server and configure the Availability Group. If a pop-up windows comes up with the text **NuGet provider is required to continue** select **Yes**.

The client or server needs to have internet access for this to work.

```powershell
If (!(Get-Module DBATools -ListAvailable)) {Install-Module DBATools -Scope CurrentUser -Force}
```

## Install Active Directory module

We will use the Active Directory module to create and configure the service account. If the installation is successfull you will se **Success** under **Exit Code**.

```powershell
Add-WindowsFeature RSAT-AD-PowerShell
```

## Create Failover Cluster

### Cluster Features

This needs to be ran on both servers. A restart is required after installation is completed.

```powershell
Install-WindowsFeature -Name failover-clustering -IncludeManagementTools -Verbose
Install-WindowsFeature -Name NET-Framework-Core -IncludeManagementTools -verbose
```

The rest of the Create Failover Cluster scripts only needs to be ran from one server.

### DNS

If DNS is not prepared we can create the A record by hand. This needs to be done on a client with the DNS tools installed.

Variables that needs to be changed

  * $clustername: Name of Windows Failover Cluster
  * $clusterIPAddress: IP address of Windows Failover Cluster
  * $agName: Name of the Availability Group
  * $agIPAddress: IP of the Availability Group
  * $zoneName: Name of the DNS zone

```powershell
$clustername = 'testnetdbcl01'
$clusterIPAddress = '10.61.42.136'

$agName = 'testnetag01'
$agIPAddress = '10.61.42.135'

$zoneName = "test.net.ad" 

Add-DnsServerResourceRecordA -Name $clustername -IPv4Address $clusterIPAddress -ZoneName $zoneName
Add-DnsServerResourceRecordA -Name $agName -IPv4Address $agIPAddress -ZoneName $zoneName
```

### File Share Witness

If a file share witness is not created before hand we can do that like this. The scripts need to be run from the file share server.

Variables that needs to be changed

  * $shareName: File share name
  * $Path: The local path to the new directory

```powershell
$shareName = "dbclun01"
$Path = "D:\dbclun01\witness"

New-Item -Path $Path -Type Directory
New-SMBShare –Name $shareName –Path $Path –FullAccess Administrators -ReadAccess Users
```

### Create Failover Cluster

Variables that needs to be changed

  * $server1: Name of the first node
  * $server2: Name of the second node
  * $clusterIPAddress: IP address of Windows Failover Cluster
  * $clustername: Name of the cluster
  * $fileshare: UNC path to the smb file share witness


```powershell
$server1 = 'testnetdb01'
$server2 = 'testnetdb02'
$clusterIPAddress = '10.61.42.136'
$clustername = 'testnetdbcl01'
$fileshare = '\\testnetquorum\testnetag01'

New-Cluster -Name $clustername -Node $server1, $server2 -StaticAddress $clusterIPAddress -NoStorage -Verbose
Set-ClusterQuorum -FileShareWitness $fileshare -Cluster $clustername -Verbose
```

## Availability Group 

### Prerequirements for Availability Group

Variables that needs to be changed

  * $serviceAccount: ServiceAccount including domain, eg test\db-e-svc

```powershell
$serviceAccount = "test\db-e-svc"

Enable-DbaAgHadr -SqlInstance $(hostname) -Force | Format-Table 

Get-DbaXESession -SqlInstance $(hostname) -Session AlwaysOn_health | ForEach-Object -Process { $_.AutoStart = $true ; $_.Alter() ; $_ | Start-DbaXESession } | Format-Table

New-DbaEndpoint -SqlInstance $(hostname) -Name hadr_endpoint -Port 5022 -EndpointEncryption Required | Start-DbaEndpoint | Format-Table
New-DbaLogin -SqlInstance $(hostname) -Login $serviceAccount | Format-Table
Invoke-DbaQuery -SqlInstance $(hostname) -Query "GRANT CONNECT ON ENDPOINT::hadr_endpoint TO [$serviceAccount]" 
```

### Create Availability Group

Variables that needs to be changed

  * $primaryNode = "testnetdb01"
  * $secondaryNode = "testnetdb02"
  * $agName = "testnetag01"
  * $sharedPath = ""
  * $tempDbName = "ag_temp"
  * $IPAddress = "10.61.42.135"

```powershell
$primaryNode = "testnetdb01"
$secondaryNode = "testnetdb02"
$agName = "testnetag01"
$sharedPath = "\\testnetquorum\testnetag01"
$tempDbName = "ag_temp"
$IPAddress = "10.61.42.135"

New-DbaDatabase -Name $tempDbName -SqlInstance $primaryNode -RecoveryModel Full
New-DbaAvailabilityGroup -Primary $primaryNode -Secondary $secondaryNode -Name $agName -ClusterType Wsfc -SharedPath $sharedPath -Database $ag_temp -ConfigureXESession -IPAddress $IPAddress
```

### Create Availability Group Listener

Verify that the Virtual Computer Objects (vco) are created as a Computer Object in Active Directory and that the Cluster Name Object (cno) has full access on the object.

```powershell
$IPAddress = "10.61.42.135"
$agListener = "testnetag01"
$SubnetMask = "255.255.255.192"

Get-DbaAvailabilityGroup -SqlInstance $primaryNode -AvailabilityGroup $agName | Add-DbaAgListener -Name $agListener -IPAddress $IPAddress -SubnetMask $SubnetMask -Verbose
```